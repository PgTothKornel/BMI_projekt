using PCSC;
using PCSC.Monitoring;

namespace NFCReaderTest
{
    class Program
    {
        static void Main()
        {
            var context = ContextFactory.Instance.Establish(SCardScope.System);

            var readerNames = context.GetReaders();
            if (readerNames.Length == 0)
            {
                Console.WriteLine("Nincs elérhető olvasó.");
                return;
            }

            string reader = readerNames[0];
            Console.WriteLine("Olvasó: " + reader);

            var monitorFactory = MonitorFactory.Instance;
            var monitor = monitorFactory.Create(SCardScope.System);

            monitor.CardInserted += (sender, args) =>
            {
                Console.WriteLine("Kártya beolvasva!");

                using (var isoReader = new IsoReader(
                    context,
                    reader,
                    SCardShareMode.Shared,
                    SCardProtocol.Any,
                    false))
                {
                    byte[] getUidCommand = { 0xFF, 0xCA, 0x00, 0x00, 0x00 };
                    var response = isoReader.Transmit(getUidCommand);

                    string uid = BitConverter.ToString(response.GetData()).Replace("-", "");
                    Console.WriteLine("UID: " + uid);
                }
            };

            monitor.Start(reader);
            Console.ReadKey();
        }
    }
}
